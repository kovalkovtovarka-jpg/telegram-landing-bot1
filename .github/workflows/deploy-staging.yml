# Deploy to Railway Staging (preview по PR)
# Запускается при открытии/обновлении PR в main или master.
#
# Секреты (опционально; если не заданы — workflow не деплоит):
#   RAILWAY_TOKEN              — тот же Project Token, что и для прода (или отдельный для staging)
#   RAILWAY_STAGING_SERVICE_ID  — UUID сервиса staging в Railway (отдельный сервис/окружение)
#   RAILWAY_STAGING_PROJECT_ID  — (опционально) UUID проекта
#   RAILWAY_STAGING_ENVIRONMENT_ID — (опционально) UUID окружения staging

name: Deploy to Staging (Preview)

on:
  pull_request:
    branches: [ main, master ]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    if: ${{ secrets.RAILWAY_STAGING_SERVICE_ID != '' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to Railway Staging
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_STAGING_SERVICE_ID }}
        RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_STAGING_PROJECT_ID }}
        RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_STAGING_ENVIRONMENT_ID }}
      run: |
        CMD="railway up --service $RAILWAY_SERVICE_ID --ci"
        if [ -n "$RAILWAY_PROJECT_ID" ] && [ -n "$RAILWAY_ENVIRONMENT_ID" ]; then
          CMD="$CMD --project $RAILWAY_PROJECT_ID --environment $RAILWAY_ENVIRONMENT_ID"
        fi
        $CMD

  skip-info:
    runs-on: ubuntu-latest
    if: ${{ secrets.RAILWAY_STAGING_SERVICE_ID == '' }}
    steps:
    - run: |
        echo "Staging deploy skipped: RAILWAY_STAGING_SERVICE_ID is not set."
        echo "To enable PR preview deploys, add RAILWAY_STAGING_SERVICE_ID (and optionally RAILWAY_STAGING_PROJECT_ID, RAILWAY_STAGING_ENVIRONMENT_ID) in GitHub Secrets."
