# Deploy to Railway
# Runs on push to main branch
#
# Secrets (Project Token, NOT account token):
#   RAILWAY_TOKEN     - Project token: Railway ‚Üí open PROJECT "exciting-quietude" ‚Üí Settings (gear) ‚Üí Tokens ‚Üí Create Token
#   RAILWAY_SERVICE_ID - Service ID (UUID from URL .../service/<uuid>)
#   RAILWAY_PROJECT_ID - Project ID (UUID from URL .../project/<uuid>) ‚Äî recommended
#   RAILWAY_ENVIRONMENT_ID - Environment ID (e.g. production UUID) ‚Äî recommended if using --project
# –î–ª—è –∞–ª–µ—Ä—Ç–∞ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –¥–µ–ø–ª–æ—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
#   TELEGRAM_BOT_TOKEN - —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
#   TELEGRAM_ADMIN_CHAT_ID - –≤–∞—à Telegram ID –∏–ª–∏ ID –≥—Ä—É–ø–ø—ã (–∫—É–¥–∞ —Å–ª–∞—Ç—å –∞–ª–µ—Ä—Ç)

name: Deploy to Railway

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check required secrets
      run: |
        if [ -z "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
          echo "::error::RAILWAY_SERVICE_ID is not set. Add it in GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions (name exactly: RAILWAY_SERVICE_ID)."
          exit 1
        fi

    - name: Deploy to Railway
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
      run: |
        CMD="railway up --service $RAILWAY_SERVICE_ID --ci"
        if [ -n "$RAILWAY_PROJECT_ID" ] && [ -n "$RAILWAY_ENVIRONMENT_ID" ]; then
          CMD="$CMD --project $RAILWAY_PROJECT_ID --environment $RAILWAY_ENVIRONMENT_ID"
        fi
        $CMD

  notify-deploy-failure:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure() && needs.deploy.result == 'failure'
    steps:
    - name: Notify admins in Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_ADMIN_CHAT_ID: ${{ secrets.TELEGRAM_ADMIN_CHAT_ID }}
      run: |
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_ADMIN_CHAT_ID" ]; then
          TEXT="üö® –î–µ–ø–ª–æ–π –Ω–∞ Railway —É–ø–∞–ª. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∫–ª–∞–¥–∫—É Actions –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_ADMIN_CHAT_ID}" \
            -d "text=$TEXT" \
            -d "disable_web_page_preview=true" || true
        fi

