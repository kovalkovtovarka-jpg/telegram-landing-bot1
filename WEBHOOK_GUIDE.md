# Подробная инструкция: Webhook для Telegram-бота на Railway

Пошаговая настройка режима webhook: что это, зачем нужно и как включить на Railway.

---

## 1. Что такое webhook и зачем он нужен

**Polling** (режим по умолчанию в `main.py`): бот сам постоянно спрашивает у Telegram «есть ли новые сообщения». Запросы идут каждые несколько секунд.

**Webhook**: Telegram сам отправляет обновления на ваш сервер по HTTPS, как только пользователь пишет боту. Сервер должен быть доступен по публичному URL.

| | Polling | Webhook |
|---|--------|--------|
| Нагрузка | Постоянные запросы к API | Только при новых сообщениях |
| Задержка | До интервала опроса | Сразу |
| Требования | Только токен и БД | Публичный HTTPS-URL |
| Рекомендация Telegram | Для разработки | Для продакшена |

**Итог:** для бота на Railway лучше использовать webhook, если вы можете выдать приложению домен (Railway это умеет).

---

## 2. Что нужно перед началом

- [ ] Аккаунт на [Railway](https://railway.app) (через GitHub).
- [ ] Репозиторий с ботом на GitHub, подключённый к проекту Railway.
- [ ] Telegram-бот создан через @BotFather, токен скопирован.
- [ ] В Railway уже есть сервис с ботом (хотя бы один успешный деплой).

Если бот ещё не деплоился на Railway — сначала выполните базовый деплой (например, по [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md)), затем возвращайтесь к этой инструкции.

---

## 3. Общая схема настройки

Порядок важен:

1. **Задеплоить** приложение (уже есть, если бот на Railway).
2. **Включить публичный домен** в настройках сервиса (Networking).
3. **Скопировать URL** вида `https://ваш-сервис.railway.app`.
4. **Добавить переменную** `WEBHOOK_URL` с этим URL (без `/webhook` в конце).
5. **Убедиться**, что запускается `webhook.py` (Procfile или Start Command).
6. **Перезапустить** сервис и проверить логи и бота.

Важно: **сначала** должен быть домен, **потом** `WEBHOOK_URL`. Иначе при старте `webhook.py` упадёт с ошибкой «WEBHOOK_URL не установлен».

---

## 4. Пошаговая настройка на Railway

### Шаг 4.1. Откройте проект и сервис

1. Зайдите на [railway.app](https://railway.app) и откройте проект с ботом.
2. В левой колонке выберите **сервис с ботом** (тот, что из GitHub, например «worker»).

### Шаг 4.2. Публичный домен (Networking)

1. Вверху откройте вкладку **Settings** (настройки сервиса).
2. Найдите блок **Networking** (или **Public Networking**).
3. Нажмите **Generate Domain** (или **Add domain** / «Сгенерировать домен»).
4. Railway создаст URL вида:
   ```text
   https://ваш-сервис-production-xxxx.up.railway.app
   ```
   или
   ```text
   https://ваш-сервис.railway.app
   ```
5. **Скопируйте этот URL целиком** — это базовый адрес приложения. Путь `/webhook` в URL указывать не нужно: бот сам зарегистрирует у Telegram адрес `https://ваш-домен/webhook`.

Если домен уже был создан ранее — просто скопируйте его из этого же раздела.

### Шаг 4.3. Переменные окружения (Variables)

1. Откройте вкладку **Variables** у того же сервиса.
2. Убедитесь, что заданы:
   - `TELEGRAM_BOT_TOKEN` — токен от @BotFather
   - `DATABASE_URL` — строка подключения к PostgreSQL (или SQLite для теста)
   - `OPENAI_API_KEY` — ключ OpenAI (или другой провайдер по вашему выбору)
3. Добавьте переменную для webhook:
   - Нажмите **New Variable** (или **Add Variable**).
   - **Name:** `WEBHOOK_URL`
   - **Value:** вставьте скопированный URL **без** `https://` в конце слеша и **без** `/webhook`.  
     Пример: `https://worker-production-0adf.up.railway.app`
4. Сохраните. Railway перезапустит сервис после изменения переменных.

### Шаг 4.4. Команда запуска (Start Command)

Нужно, чтобы на Railway запускался именно webhook, а не polling.

**Вариант A: используется Procfile (рекомендуется)**

В корне репозитория должен быть файл **Procfile** с одной строкой:

```text
web: python webhook.py
```

Если у вас так и есть — ничего менять не нужно. Railway при деплое возьмёт команду из Procfile.

**Вариант B: команда задаётся в Railway**

1. В настройках сервиса откройте **Settings**.
2. Найдите раздел **Build** или **Deploy** / **Start Command**.
3. В поле **Start Command** (если оно переопределяет Procfile) укажите:
   ```text
   python webhook.py
   ```
4. Сохраните. Сервис перезапустится с новой командой.

Если Start Command пустой — Railway использует Procfile. Если там было `python main.py` (polling), замените на `python webhook.py`.

### Шаг 4.5. Порты

Railway сам задаёт переменную **PORT**. Ваш код в `webhook.py` использует её через `Config.WEBHOOK_PORT` (в `backend/config.py` читается `PORT` из окружения). Дополнительно ничего настраивать не нужно.

---

## 5. Проверка работы

### 5.1. Логи после перезапуска

1. Вкладка **Deployments** → откройте последний деплой → **View Logs**.
2. В конце логов должны быть строки примерно такого вида:
   ```text
   Проверка конфигурации...
   ✓ Конфигурация валидна
   ...
   Настройка webhook: https://ваш-домен.railway.app/webhook
   ✓ Webhook установлен: https://ваш-домен.railway.app/webhook
   ✓ Webhook сервер запущен на порту XXXX
   ```
3. Если видите **«WEBHOOK_URL не установлен»** — вернитесь к шагу 4.3 и проверьте переменную `WEBHOOK_URL`.
4. Если видите **«Application started»** и дальше ошибки про порт — проверьте, что в Start Command именно `python webhook.py` и переменная `PORT` не перезаписана вручную лишним значением.

### 5.2. Health check в браузере

1. Откройте в браузере:
   ```text
   https://ваш-домен.railway.app/health
   ```
   (подставьте свой домен из шага 4.2.)
2. Должен вернуться JSON с полем `"status": "healthy"` и код ответа 200.
3. Если страница не открывается — проверьте, что домен сгенерирован (шаг 4.2) и деплой успешен.

### 5.3. Проверка бота в Telegram

1. Откройте Telegram и найдите вашего бота.
2. Нажмите **Start** или отправьте команду `/start`.
3. Бот должен ответить приветствием. Если отвечает — webhook работает.

Если бот не отвечает:

- Проверьте логи (п. 5.1): нет ли ошибок при установке webhook.
- Убедитесь, что `WEBHOOK_URL` — именно тот домен, который открывается в браузере (и что вы открываете `/health` по HTTPS).
- Проверьте, что в Variables нет опечатки в `TELEGRAM_BOT_TOKEN`.

---

## 6. Формат WEBHOOK_URL — кратко

| Правильно | Неправильно |
|-----------|-------------|
| `https://worker-production-0adf.up.railway.app` | `https://.../webhook` (путь не нужен) |
| Без слеша в конце | `https://.../` (лучше без) |
| Только HTTPS | `http://...` (Telegram не примет) |

В коде бота к `WEBHOOK_URL` автоматически добавляется путь `/webhook`, и этот полный URL регистрируется в Telegram.

---

## 7. Частые проблемы

**Ошибка при старте: «WEBHOOK_URL не установлен»**  
- Добавьте переменную `WEBHOOK_URL` в Variables (шаг 4.3).  
- После первого деплоя домен уже есть — скопируйте его из Settings → Networking и вставьте в значение переменной.

**Бот не отвечает в Telegram**  
- В логах должна быть строка «✓ Webhook установлен: https://...». Если её нет — проверьте логи с начала: возможно, падение до установки webhook (нет токена, БД и т.д.).  
- Откройте в браузере `https://ваш-домен.railway.app/health`. Если не открывается — домен не тот или сервис не слушает порт (должен быть запущен `webhook.py`).

**После смены домена бот перестал отвечать**  
- В Variables обновите `WEBHOOK_URL` на новый домен.  
- Сохраните переменные (Railway перезапустит сервис) и снова проверьте логи и `/start`.

**Сейчас запускается main.py (polling)**  
- Замените команду запуска на `python webhook.py` (в Procfile или в Start Command в Railway), задайте домен и `WEBHOOK_URL` по этой инструкции, затем перезапустите сервис.

---

## 8. Переход с polling на webhook

Если бот уже работает на Railway в режиме polling (`python main.py`):

1. Выполните шаги 4.2–4.4: создайте домен, добавьте `WEBHOOK_URL`, смените команду на `python webhook.py`.
2. После перезапуска Telegram будет слать обновления на ваш URL; polling больше не нужен.
3. Проверку сделайте по разделу 5.

Обратно на polling: в Start Command укажите `python main.py`, переменную `WEBHOOK_URL` можно не удалять (она просто не будет использоваться).

---

## 9. Полезные ссылки

- [DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md) — общий деплой на Railway.
- [HOW_TO_GET_WEBHOOK_URL.md](HOW_TO_GET_WEBHOOK_URL.md) — как получить URL для webhook.
- [WEBHOOK_SETUP.md](WEBHOOK_SETUP.md) — краткая настройка webhook и переменные.

После выполнения этой инструкции бот работает в режиме webhook на Railway и готов к использованию в продакшене.
